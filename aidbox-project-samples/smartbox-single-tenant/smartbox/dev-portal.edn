{ns smartbox.dev-portal
 import #{aidbox
          aidbox.rest
          smartbox.demo-fixtures
          smartbox.smart-api
          smartbox.bulk-api

          smartbox.documentation
          smartbox.portal.config

          smartbox.portal.seed
          smartbox.portal.rpc

          smartbox.portal.developer.rpc
          smartbox.portal.developer.seed

          hl7-fhir-r4-core
          hl7-fhir-us-core
          zenbox}

 box
 {:zen/tags #{aidbox/system}
  :services {:http                  server
             :seed                  access-policies
             :portal-seed           smartbox.portal.seed/resources
             :portal-developer-seed smartbox.portal.developer.seed/resources}}

 server
 {:zen/tags #{aidbox/service}
  :engine   aidbox/http
  :apis     #{api}}

 access-policies
 {:zen/tags  #{aidbox/service}
  :engine    aidbox/seed
  :resources [{:id "smart-api"
               :resourceType "AccessPolicy"
               :engine "matcho"
               :matcho {:uri "#/smart/.*"
                        :session {:audience "#.+smart$"}}}
              {:id "inferno-public-endpoints"
               :resourceType "AccessPolicy"
               :engine "matcho"
               :matcho {:uri {:$one-of ["/"
                                        "/documentation"
                                        "/inferno"
                                        "/inferno/create-demo-user"
                                        "/inferno/logout"
                                        "/smart/api"
                                        "/smart/demo/profile"
                                        "/smart/demo/login"
                                        "/smart-auth/grant"]}}}
              {:id "smart-api-public-endpoints"
               :resourceType "AccessPolicy"
               :engine "matcho"
               :matcho {:uri {:$one-of ["/smart/metadata"
                                        "/smart/.well-known/smart-configuration"
                                        "/smart/style-v1.json"
                                        "/smart-auth/grant"]}}}
              {:id "bulk-api-metadata"
               :resourceType "AccessPolicy"
               :engine "matcho"
               :matcho {:uri "/bulk/metadata"}}
              {:id "bulk-api-redirect"
               :resourceType "AccessPolicy"
               :engine "matcho"
               :matcho {:uri "/bulk/$redirect"}}
              {:id "bulk-api-client-system-all-read"
               :resourceType "AccessPolicy"
               :engine "matcho"
               :matcho {:uri {:$one-of ["#/bulk/Group/.+/\\$export"
                                        "#/bulk/Group/[^/]+$"
                                        "#/bulk/Group"
                                        "#/bulk/\\$export-status/.+"]}
                        :client {:type "bulk"}}}]}

 dev-portal-ui
 {:zen/tags #{aidbox.rest/op aidbox.rest.smart/public}
  :engine   aidbox.rest.v1/aidbox-action
  :action   :box.rest.smart/smartbox-ui
  :sign-up-url "#/dev/enroll"}

 api
 {:zen/tags #{aidbox.rest/api}

  "smart-auth" {"grant" {:GET smartbox.smart-api/grant-view}}

  :GET dev-portal-ui

  "smart" {:apis #{smartbox.smart-api/smart-api
                   smartbox.smart-api/public-api}}
  "bulk"  {:apis #{smartbox.bulk-api/bulk-api}}}

 }
